name: vHive CRI tests

on:
  workflow_call:
    inputs:
      sandbox:
        required: true
        type: string

env:
  GO111MODULE: on

jobs:
  cri-tests:
    name: CRI tests
    env:
      GITHUB_RUN_ID: ${{ github.run_id }}
      GITHUB_VHIVE_ARGS: "-dbg"
    runs-on: ubuntu-24.04

    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet \
                      /opt/ghc \
                      /usr/local/share/boost \
                      "$AGENT_TOOLSDIRECTORY" \
                      /usr/local/lib/android \
                      /opt/hostedtoolcache/CodeQL
          sudo apt-get clean
          docker system prune -af --volumes

      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go version in go.mod file
        uses: actions/setup-go@v6
        with:
          go-version-file: ${{ github.workspace }}/go.mod
          cache-dependency-path: |
            **/go.sum
            **/go.mod

      - name: Add rsync
        run: |
          sudo apt update
          sudo apt install rsync -y

      - name: Build setup scripts
        run: pushd scripts && go build -o setup_tool && popd

      - name: Setup Node
        run: ./scripts/setup_tool setup_node ${{ inputs.sandbox }}

      - name: Setup vHive CRI test environment
        run: ./scripts/github_runner/setup_cri_test_env.sh ${{ inputs.sandbox }}

      - name: Debug network connectivity
        run: |
          echo "=== Checking CoreDNS status ==="
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl get pods -n kube-system -l k8s-app=kube-dns
          
          echo "=== Testing pod network connectivity ==="
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl run network-test --image=busybox:1.28 --restart=Never --command -- sleep 3600 || true
          sleep 15
          
          echo "=== DNS resolution test ==="
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl exec network-test -- nslookup kubernetes.default || echo "Internal DNS failed"
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl exec network-test -- nslookup docker.io || echo "Docker Hub DNS failed"
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl exec network-test -- nslookup ghcr.io || echo "ghcr.io DNS failed"
          
          echo "=== Network connectivity test ==="
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl exec network-test -- ping -c 3 8.8.8.8 || echo "Ping to 8.8.8.8 failed"
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl exec network-test -- wget -T 10 -O- https://index.docker.io/v2/ || echo "HTTPS to Docker Hub failed"
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl exec network-test -- wget -T 10 -O- https://ghcr.io/v2/ || echo "HTTPS to ghcr.io failed"
          
          echo "=== Test pulling actual images used in tests ==="
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl exec network-test -- wget -T 10 -O- https://registry-1.docker.io/v2/crccheck/hello-world/manifests/latest || echo "Docker Hub crccheck/hello-world pull failed"
          
          echo "=== Cleaning up test pod ==="
          sudo KUBECONFIG=/etc/kubernetes/admin.conf kubectl delete pod network-test --force --grace-period=0 || true
          
          echo "=== Checking iptables NAT rules ==="
          sudo iptables -t nat -L POSTROUTING -n -v | grep MASQUERADE || echo "No MASQUERADE rules found"
      
      - name: Run vHive CRI tests
        run: source /etc/profile && go clean -testcache && go test ./cri -v -race -cover

      - name: Run sandbox specific tests
        if: ${{ inputs.sandbox == 'firecracker' }}
        run: source /etc/profile && go clean -testcache && go test ./cri/${{ inputs.sandbox }} -v -race -cover

      - name: Archive log artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: ctrd-logs
          path: |
            /tmp/ctrd-logs/
            ${{ github.workspace }}/*.log
            ${{ github.workspace }}/scripts/github_runner/*.log